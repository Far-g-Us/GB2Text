name: Issue Triage System
on:
  issues:
    types: [opened]

jobs:
  classify_and_respond:
    runs-on: ubuntu-latest
    steps:
      - name: Classify issue type
        id: classifier
        uses: actions/github-script@v6
        with:
          script: |
            const { title, body } = context.payload.issue;
            const content = (title + ' ' + body).toLowerCase();
            
            const labelsMap = {
              'bug': ['error', 'crash', 'fail', 'ошибка', 'баг', 'проблема'],
              'enhancement': ['feature', 'улучшение', 'предложение', 'функция'],
              'documentation': ['doc', 'readme', 'help', 'документация'],
              'game-support': ['game', 'игра', 'rom', 'картридж'],
              'text-extraction': ['text', 'текст', 'string', 'диалог']
            };
            
            const detectedLabels = [];
            for (const [label, keywords] of Object.entries(labelsMap)) {
              if (keywords.some(kw => content.includes(kw))) {
                detectedLabels.push(label);
              }
            }
            
            let responseType = 'general';
            if (detectedLabels.includes('bug')) responseType = 'bug';
            else if (detectedLabels.includes('enhancement')) responseType = 'enhancement';
            
            return { 
              labels: JSON.stringify(detectedLabels),
              responseType: responseType
            };

      - name: Apply labels
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: ${{ steps.classifier.outputs.result }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Send response
        uses: actions/github-script@v6
        with:
          script: |
            const bugMsg = "### Спасибо за отчет об ошибке!\n\nДля диагностики укажите:\n1. Хэш SHA-256 ROM-файла\n2. Адрес памяти где возникает ошибка\n3. Версия игры (USA/EUR/JPN)\n\nНе прикладывайте ROM файлы - это нарушает авторские права.";
            
            const enhanceMsg = "### Спасибо за предложение!\n\nМы рассмотрим ваше предложение. Проверьте похожие issue.";
            
            const generalMsg = "### Спасибо за обращение!\n\nМы ответим в ближайшее время.";
            
            const responseTypes = {
              'bug': bugMsg,
              'enhancement': enhanceMsg,
              'general': generalMsg
            };
            
            const response = responseTypes.general;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: response
            });
